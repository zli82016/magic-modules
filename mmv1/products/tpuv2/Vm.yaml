# Copyright 2024 Google Inc.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
name: Vm
api_resource_type_kind: Node
description: |
  A Cloud TPU VM instance.
references:
  guides:
    Official Documentation: https://cloud.google.com/tpu/docs/
  api: https://cloud.google.com/tpu/docs/reference/rest/v2/projects.locations.nodes
base_url: projects/{{project}}/locations/{{zone}}/nodes
min_version: beta
self_link: projects/{{project}}/locations/{{zone}}/nodes/{{name}}
create_url: projects/{{project}}/locations/{{zone}}/nodes?nodeId={{name}}
update_url: projects/{{project}}/locations/{{zone}}/nodes/{{name}}
update_mask: true
update_verb: PATCH
custom_diff:
  - acceleratorTypeCustomizeDiff
sweeper:
  url_substitutions:
    - zone: us-central1-c
async:
  operation:
    base_url: '{{op_id}}'
  result:
    resource_inside_response: true
autogen_async: true
custom_code:
  constants: templates/terraform/constants/tpu_vm.go.tmpl
examples:
  - name: tpu_v2_vm_basic
    primary_resource_id: tpu
    min_version: beta
    vars:
      vm_name: test-tpu
    skip_vcr: true
  - name: tpu_v2_vm_full
    primary_resource_id: tpu
    min_version: beta
    vars:
      disk_name: tpu-disk
      network_name: tpu-net
      sa_id: tpu-sa
      subnet_name: tpu-subnet
      vm_name: test-tpu
    skip_vcr: true
    external_providers:
      - random
      - time
parameters:
  - name: zone
    type: String
    description: |
      The GCP location for the TPU. If it is not provided, the provider zone is used.
    immutable: true
    url_param_only: true
    min_version: beta
    default_from_api: true
properties:
  - name: name
    type: String
    required: true
    description: |
      The immutable name of the TPU.
    immutable: true
    min_version: beta
    custom_flatten: templates/terraform/custom_flatten/name_from_self_link.tmpl
  - name: runtimeVersion
    type: String
    required: true
    description: |
      Runtime version for the TPU.
    immutable: true
    min_version: beta
  - name: acceleratorType
    type: String
    description: |
      TPU accelerator type for the TPU. `accelerator_type` cannot be used at the same time as
      `accelerator_config`. If neither is specified, `accelerator_type` defaults to 'v2-8'.
    immutable: true
    min_version: beta
    conflicts:
      - accelerator_config
    default_from_api: true
  - name: description
    type: String
    description: |
      Text description of the TPU.
    min_version: beta
  - name: cidrBlock
    type: String
    description: |
      The CIDR block that the TPU node will use when selecting an IP address. This CIDR block must
      be a /29 block; the Compute Engine networks API forbids a smaller block, and using a larger
      block would be wasteful (a node can only consume one IP address). Errors will occur if the
      CIDR block has already been used for a currently existing TPU node, the CIDR block conflicts
      with any subnetworks in the user's provided network, or the provided network is peered with
      another network that is using that CIDR block.
    immutable: true
    min_version: beta
    default_from_api: true
  - name: networkConfig
    type: NestedObject
    description: |
      Network configurations for the TPU node.
    immutable: true
    min_version: beta
    conflicts:
      - network_configs
    default_from_api: true
    properties:
      - name: network
        type: String
        description: |
          The name of the network for the TPU node. It must be a preexisting Google Compute Engine
          network. If none is provided, "default" will be used.
        immutable: true
        min_version: beta
        default_from_api: true
      - name: subnetwork
        type: String
        description: |
          The name of the subnetwork for the TPU node. It must be a preexisting Google Compute
          Engine subnetwork. If none is provided, "default" will be used.
        immutable: true
        min_version: beta
        default_from_api: true
      - name: enableExternalIps
        type: Boolean
        description: |
          Indicates that external IP addresses would be associated with the TPU workers. If set to
          false, the specified subnetwork or network should have Private Google Access enabled.
        immutable: true
        send_empty_value: true
        min_version: beta
      - name: canIpForward
        type: Boolean
        description: |
          Allows the TPU node to send and receive packets with non-matching destination or source
          IPs. This is required if you plan to use the TPU workers to forward routes.
        immutable: true
        send_empty_value: true
        min_version: beta
      - name: queueCount
        type: Integer
        description: |
          Specifies networking queue count for TPU VM instance's network interface.
        immutable: true
        min_version: beta
  - name: networkConfigs
    type: Array
    description: |
      Repeated network configurations for the TPU node. This field is used to specify multiple
      network configs for the TPU node.
    immutable: true
    min_version: beta
    conflicts:
      - network_config
    item_type:
      type: NestedObject
      properties:
        - name: network
          type: String
          description: |
            The name of the network for the TPU node. It must be a preexisting Google Compute Engine
            network. If none is provided, "default" will be used.
          immutable: true
          min_version: beta
          default_from_api: true
        - name: subnetwork
          type: String
          description: |
            The name of the subnetwork for the TPU node. It must be a preexisting Google Compute
            Engine subnetwork. If none is provided, "default" will be used.
          immutable: true
          min_version: beta
          default_from_api: true
        - name: enableExternalIps
          type: Boolean
          description: |
            Indicates that external IP addresses would be associated with the TPU workers. If set to
            false, the specified subnetwork or network should have Private Google Access enabled.
          immutable: true
          send_empty_value: true
          min_version: beta
        - name: canIpForward
          type: Boolean
          description: |
            Allows the TPU node to send and receive packets with non-matching destination or source
            IPs. This is required if you plan to use the TPU workers to forward routes.
          immutable: true
          send_empty_value: true
          min_version: beta
        - name: queueCount
          type: Integer
          description: |
            Specifies networking queue count for TPU VM instance's network interface.
          immutable: true
          min_version: beta
  - name: serviceAccount
    type: NestedObject
    description: |
      The Google Cloud Platform Service Account to be used by the TPU node VMs. If None is
      specified, the default compute service account will be used.
    immutable: true
    min_version: beta
    default_from_api: true
    properties:
      - name: email
        type: String
        description: |
          Email address of the service account. If empty, default Compute service account will be used.
        immutable: true
        min_version: beta
        default_from_api: true
      - name: scope
        type: Array
        description: |
          The list of scopes to be made available for this service account. If empty, access to all
          Cloud APIs will be allowed.
        immutable: true
        min_version: beta
        diff_suppress_func: tpuServiceAccountAddedScopesSuppress
        default_from_api: true
        item_type:
          type: String
  - name: schedulingConfig
    type: NestedObject
    description: |
      The scheduling options for this node.
    immutable: true
    min_version: beta
    properties:
      - name: preemptible
        type: Boolean
        description: |
          Defines whether the node is preemptible.
        immutable: true
        send_empty_value: true
        min_version: beta
      - name: reserved
        type: Boolean
        description: |
          Whether the node is created under a reservation.
        immutable: true
        send_empty_value: true
        min_version: beta
      - name: spot
        type: Boolean
        description: |
          Optional. Defines whether the node is Spot VM.
        immutable: true
        min_version: beta
  - name: dataDisks
    type: Array
    description: |
      The additional data disks for the Node.
    min_version: beta
    item_type:
      type: NestedObject
      properties:
        - name: sourceDisk
          type: String
          required: true
          description: |
            Specifies the full path to an existing disk. For example:
            "projects/my-project/zones/us-central1-c/disks/my-disk".
          min_version: beta
        - name: mode
          type: Enum
          default_value: READ_WRITE
          description: |
            The mode in which to attach this disk. If not specified, the default is READ_WRITE
            mode. Only applicable to dataDisks.
          min_version: beta
          enum_values:
            - READ_WRITE
            - READ_ONLY
  - name: shieldedInstanceConfig
    type: NestedObject
    description: |
      Shielded Instance options.
    immutable: true
    min_version: beta
    properties:
      - name: enableSecureBoot
        type: Boolean
        required: true
        description: |
          Defines whether the instance has Secure Boot enabled.
        immutable: true
        send_empty_value: true
        min_version: beta
  - name: acceleratorConfig
    type: NestedObject
    description: |
      The AccleratorConfig for the TPU Node. `accelerator_config` cannot be used at the same time
      as `accelerator_type`. If neither is specified, `accelerator_type` defaults to 'v2-8'.
    immutable: true
    min_version: beta
    conflicts:
      - accelerator_type
    default_from_api: true
    properties:
      - name: type
        type: String
        required: true
        description: |
          Type of TPU. Please select one of the allowed types: https://cloud.google.com/tpu/docs/reference/rest/v2/AcceleratorConfig#Type
        immutable: true
        min_version: beta
      - name: topology
        type: String
        required: true
        description: |
          Topology of TPU in chips.
        immutable: true
        min_version: beta
  - name: labels
    type: KeyValueLabels
    description: Resource labels to represent user-provided metadata.
    min_version: beta
  - name: metadata
    type: KeyValuePairs
    description: Custom metadata to apply to the TPU Node. Can set startup-script and shutdown-script.
    min_version: beta
  - name: tags
    type: Array
    description: |
      Tags to apply to the TPU Node. Tags are used to identify valid sources or targets for network firewalls.
    min_version: beta
    item_type:
      type: String
  - name: state
    type: String
    description: |
      The current state for the TPU Node.
    output: true
    min_version: beta
  - name: health
    type: String
    description: |
      The health status of the TPU node.
    output: true
    min_version: beta
  - name: healthDescription
    type: String
    description: |
      If this field is populated, it contains a description of why the TPU Node is unhealthy.
    output: true
    min_version: beta
  - name: apiVersion
    type: String
    description: |
      The API version that created this Node.
    output: true
    min_version: beta
  - name: queuedResource
    type: String
    description: |
      The qualified name of the QueuedResource that requested this Node.
    output: true
    min_version: beta
  - name: multisliceNode
    type: Boolean
    description: |
      Whether the Node belongs to a Multislice group.
    output: true
    min_version: beta
  - name: networkEndpoints
    type: Array
    description: |
      The network endpoints where TPU workers can be accessed and sent work. It is recommended that
      runtime clients of the node reach out to the 0th entry in this map first.
    output: true
    min_version: beta
    item_type:
      type: NestedObject
      properties:
        - name: ipAddress
          type: String
          description: |
            The internal IP address of this network endpoint.
          output: true
          min_version: beta
        - name: port
          type: Integer
          description: |
            The port of this network endpoint.
          output: true
          min_version: beta
        - name: accessConfig
          type: NestedObject
          description: |
            The access config for the TPU worker.
          output: true
          min_version: beta
          properties:
            - name: externalIp
              type: String
              description: |
                An external IP address associated with the TPU worker.
              output: true
              min_version: beta
  - name: symptoms
    type: Array
    description: |
      The Symptoms that have occurred to the TPU Node.
    output: true
    min_version: beta
    item_type:
      type: NestedObject
      properties:
        - name: createTime
          type: String
          description: |
            Timestamp when the Symptom is created.
          output: true
          min_version: beta
        - name: symptomType
          type: String
          description: |
            Type of the Symptom.
          output: true
          min_version: beta
        - name: details
          type: String
          description: |
            Detailed information of the current Symptom.
          output: true
          min_version: beta
        - name: workerId
          type: String
          description: |
            A string used to uniquely distinguish a worker within a TPU node.
          output: true
          min_version: beta
