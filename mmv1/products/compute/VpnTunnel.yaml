# Copyright 2024 Google Inc.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
name: VpnTunnel
description: VPN tunnel resource.
references:
  guides:
    Cloud VPN Overview: https://cloud.google.com/vpn/docs/concepts/overview
    Networks and Tunnel Routing: https://cloud.google.com/vpn/docs/concepts/choosing-networks-routing
  api: https://cloud.google.com/compute/docs/reference/rest/v1/vpnTunnels
base_url: projects/{{project}}/regions/{{region}}/vpnTunnels
immutable: true
has_self_link: true
collection_url_key: items
kind: compute#vpnTunnel
id_format: projects/{{project}}/regions/{{region}}/vpnTunnels/{{name}}
async:
  operation:
    base_url: '{{op_id}}'
custom_code:
  encoder: templates/terraform/encoders/vpn_tunnel.go.tmpl
  constants: templates/terraform/constants/vpn_tunnel.tmpl
  post_create: templates/terraform/post_create/labels.tmpl
examples:
  - name: vpn_tunnel_basic
    primary_resource_id: tunnel1
    vars:
      address_name: vpn-static-ip
      esp_forwarding_rule_name: fr-esp
      network_name: network-1
      route_name: route1
      target_vpn_gateway_name: vpn-1
      udp500_forwarding_rule_name: fr-udp500
      udp4500_forwarding_rule_name: fr-udp4500
      vpn_tunnel_name: tunnel-1
  - name: vpn_tunnel_cipher_suite
    primary_resource_id: tunnel1
    vars:
      address_name: vpn-static-ip
      esp_forwarding_rule_name: fr-esp
      network_name: network-1
      route_name: route1
      target_vpn_gateway_name: vpn-1
      udp500_forwarding_rule_name: fr-udp500
      udp4500_forwarding_rule_name: fr-udp4500
      vpn_tunnel_name: tunnel-cipher
parameters:
  - name: region
    type: ResourceRef
    description: The region where the tunnel is located. If unset, is set to the region of `target_vpn_gateway`.
    resource: Region
    imports: name
    default_from_api: true
    custom_expand: templates/terraform/custom_expand/resourceref_with_validation.go.tmpl
    custom_flatten: templates/terraform/custom_flatten/name_from_self_link.tmpl
properties:
  - name: tunnel_id
    api_name: id
    type: String
    description: The unique identifier for the resource. This identifier is defined by the server.
    output: true
  - name: creationTimestamp
    type: Time
    description: Creation timestamp in RFC3339 text format.
    output: true
  - name: name
    type: String
    required: true
    description: |
      Name of the resource. The name must be 1-63 characters long, and
      comply with RFC1035. Specifically, the name must be 1-63
      characters long and match the regular expression
      `[a-z]([-a-z0-9]*[a-z0-9])?` which means the first character
      must be a lowercase letter, and all following characters must
      be a dash, lowercase letter, or digit,
      except the last character, which cannot be a dash.
  - name: description
    type: String
    description: |
      An optional description of this resource.
    immutable: true
  - name: targetVpnGateway
    type: ResourceRef
    description: |
      URL of the Target VPN gateway with which this VPN tunnel is
      associated.
    immutable: true
    resource: VpnGateway
    imports: selfLink
    custom_expand: templates/terraform/custom_expand/resourceref_with_validation.go.tmpl
  - name: vpnGateway
    type: ResourceRef
    description: |
      URL of the VPN gateway with which this VPN tunnel is associated.
      This must be used if a High Availability VPN gateway resource is created.
      This field must reference a `google_compute_ha_vpn_gateway` resource.
    immutable: true
    resource: HaVpnGateway
    imports: selfLink
    custom_expand: templates/terraform/custom_expand/resourceref_with_validation.go.tmpl
  - name: vpnGatewayInterface
    type: Integer
    description: |
      The interface ID of the VPN gateway with which this VPN tunnel is associated.
    immutable: true
    send_empty_value: true
  - name: peerExternalGateway
    type: ResourceRef
    description: |
      URL of the peer side external VPN gateway to which this VPN tunnel is connected.
    immutable: true
    conflicts:
      - peer_gcp_gateway
    resource: ExternalVpnGateway
    imports: selfLink
    custom_expand: templates/terraform/custom_expand/resourceref_with_validation.go.tmpl
  - name: peerExternalGatewayInterface
    type: Integer
    description: |
      The interface ID of the external VPN gateway to which this VPN tunnel is connected.
    send_empty_value: true
  - name: peerGcpGateway
    type: ResourceRef
    description: |
      URL of the peer side HA GCP VPN gateway to which this VPN tunnel is connected.
      If provided, the VPN tunnel will automatically use the same vpn_gateway_interface
      ID in the peer GCP VPN gateway.
      This field must reference a `google_compute_ha_vpn_gateway` resource.
    conflicts:
      - peer_external_gateway
    resource: HaVpnGateway
    imports: selfLink
    custom_expand: templates/terraform/custom_expand/resourceref_with_validation.go.tmpl
  - name: router
    type: ResourceRef
    description: |
      URL of router resource to be used for dynamic routing.
    immutable: true
    resource: Router
    imports: selfLink
    custom_expand: templates/terraform/custom_expand/compute_full_url.tmpl
  - name: peerIp
    type: String
    description: |
      IP address of the peer VPN gateway. Only IPv4 is supported.
    validation:
      function: validatePeerAddr
    default_from_api: true
  - name: sharedSecret
    type: String
    required: true
    description: |
      Shared secret used to set the secure session between the Cloud VPN
      gateway and the peer VPN gateway.
    write_only: true
    ignore_read: true
  - name: sharedSecretHash
    type: String
    description: |
      Hash of the shared secret.
    output: true
  - name: ikeVersion
    type: Integer
    default_value: 2
    description: |
      IKE protocol version to use when establishing the VPN tunnel with
      peer VPN gateway.
      Acceptable IKE versions are 1 or 2. Default version is 2.
  - name: localTrafficSelector
    type: Array
    description: |
      Local traffic selector to use when establishing the VPN tunnel with
      peer VPN gateway. The value should be a CIDR formatted string,
      for example `192.168.0.0/16`. The ranges should be disjoint.
      Only IPv4 is supported.
    is_set: true
    default_from_api: true
    item_type:
      type: String
  - name: remoteTrafficSelector
    type: Array
    description: |
      Remote traffic selector to use when establishing the VPN tunnel with
      peer VPN gateway. The value should be a CIDR formatted string,
      for example `192.168.0.0/16`. The ranges should be disjoint.
      Only IPv4 is supported.
    is_set: true
    default_from_api: true
    item_type:
      type: String
  - name: labels
    type: KeyValueLabels
    description: Labels to apply to this VpnTunnel.
    update_verb: POST
    update_url: projects/{{project}}/regions/{{region}}/vpnTunnels/{{name}}/setLabels
  - name: labelFingerprint
    type: Fingerprint
    description: |
      The fingerprint used for optimistic locking of this resource.  Used
      internally during updates.
    update_verb: POST
    update_url: projects/{{project}}/regions/{{region}}/vpnTunnels/{{name}}/setLabels
  - name: detailedStatus
    type: String
    description: Detailed status message for the VPN tunnel.
    output: true
  - name: params
    type: NestedObject
    description: |
      Additional params passed with the request, but not persisted as part of resource payload
    immutable: true
    min_version: beta
    ignore_read: true
    properties:
      - name: resourceManagerTags
        type: KeyValuePairs
        description: |
          Resource manager tags to be bound to the Vpn Tunnel. Tag keys and values have the
          same definition as resource manager tags. Keys must be in the format tagKeys/{tag_key_id},
          and values are in the format tagValues/456.
        ignore_read: true
  - name: cipherSuite
    type: NestedObject
    description: |
      User specified list of ciphers to use for the phase 1 and phase 2 of the IKE protocol.
    properties:
      - name: phase1
        type: NestedObject
        description: Cipher configuration for phase 1 of the IKE protocol.
        properties:
          - name: encryption
            type: Array
            description: Encryption algorithms.
            item_type:
              type: String
          - name: integrity
            type: Array
            description: Integrity algorithms.
            item_type:
              type: String
          - name: prf
            type: Array
            description: Pseudo-random functions.
            item_type:
              type: String
          - name: dh
            type: Array
            description: Diffie-Hellman groups.
            item_type:
              type: String
      - name: phase2
        type: NestedObject
        description: Cipher configuration for phase 2 of the IKE protocol.
        properties:
          - name: encryption
            type: Array
            description: Encryption algorithms.
            item_type:
              type: String
          - name: integrity
            type: Array
            description: Integrity algorithms.
            item_type:
              type: String
          - name: pfs
            type: Array
            description: Perfect forward secrecy groups.
            item_type:
              type: String
