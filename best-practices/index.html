<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Best practices # The following is a list of best practices that contributions are expected to follow in order to ensure a consistent UX for the Terraform provider for Google Cloud internally and also compared to other Terraform providers.
ForceNew # ForceNew in a Terraform resource schema attribute that indicates that a field is immutable – that is, that a change to the field requires the resource to be destroyed and recreated."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="Best practices"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://googlecloudplatform.github.io/magic-modules/best-practices/"><title>Best practices | Magic Modules</title><link rel=manifest href=/magic-modules/manifest.json><link rel=icon href=/magic-modules/favicon.png type=image/x-icon><link rel=stylesheet href=/magic-modules/book.min.33a48f5432973b8ff9a82679d9e45d67f2c15d4399bd2829269455cfe390b5e8.css integrity="sha256-M6SPVDKXO4/5qCZ52eRdZ/LBXUOZvSgpJpRVz+OQteg=" crossorigin=anonymous><script defer src=/magic-modules/flexsearch.min.js></script>
<script defer src=/magic-modules/en.search.min.41e1c8c49351a927229da45a5711c75dc6f90c844a1ee789b6686a9421fb08f0.js integrity="sha256-QeHIxJNRqScinaRaVxHHXcb5DIRKHueJtmhqlCH7CPA=" crossorigin=anonymous></script>
<link rel=alternate type=application/rss+xml href=https://googlecloudplatform.github.io/magic-modules/best-practices/index.xml title="Magic Modules"></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/magic-modules/><img src=/magic-modules/magic-modules.svg alt=Logo><span>Magic Modules</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/magic-modules/>Overview</a></li></ul><ul><li><span>Get started</span><ul><li><a href=/magic-modules/get-started/generate-providers/>Generate the providers</a></li><li><a href=/magic-modules/get-started/how-magic-modules-works/>How Magic Modules works</a></li><li><a href=/magic-modules/get-started/contribution-process/>Contribution process</a></li></ul></li><li><span>Develop</span><ul><li><a href=/magic-modules/develop/resource/>Add or modify a resource</a></li><li><a href=/magic-modules/develop/field-reference/>MMv1 field reference</a></li><li><a href=/magic-modules/develop/custom-code/>Add custom resource code</a></li><li><a href=/magic-modules/develop/add-handwritten-datasource/>Add a datasource</a></li><li><a href=/magic-modules/develop/promote-to-ga/>Promote to GA</a></li><li><a href=/magic-modules/develop/permadiff/>Fix a permadiff</a></li><li><input type=checkbox id=section-9ccce47fb686ac21da7c5aafec70c7aa class=toggle>
<label for=section-9ccce47fb686ac21da7c5aafec70c7aa class="flex justify-between"><a role=button>Test</a></label><ul><li><a href=/magic-modules/develop/test/test/>Add resource tests</a></li><li><a href=/magic-modules/develop/test/run-tests/>Run tests</a></li></ul></li><li><input type=checkbox id=section-74c6da531f3d2c4b4f43bdae497559e2 class=toggle>
<label for=section-74c6da531f3d2c4b4f43bdae497559e2 class="flex justify-between"><a role=button>Breaking changes</a></label><ul><li><a href=/magic-modules/develop/breaking-changes/breaking-changes/>Types of breaking changes</a></li><li><a href=/magic-modules/develop/breaking-changes/make-a-breaking-change/>Make a breaking change</a></li></ul></li><li><a href=/magic-modules/develop/handwritten-docs-style-guide/>Handwritten docs style guide</a></li></ul></li><li><a href=/magic-modules/best-practices/ class=active>Best practices</a><ul></ul></li><li><span>Contribute</span><ul><li><a href=/magic-modules/contribute/create-pr/>Create a pull request</a></li><li><a href=/magic-modules/contribute/release-notes/>Write release notes</a></li><li><a href=/magic-modules/contribute/review-pr/>Review a pull request</a></li></ul></li><li><span>Reference</span><ul><li><a href=/magic-modules/reference/make-commands/>make commands</a></li><li><a href=https://github.com/GoogleCloudPlatform/magic-modules/blob/main/mmv1/api/resource.rb target=_blank rel=noopener>Resource YAML reference ↗</a></li><li><a href=https://github.com/GoogleCloudPlatform/magic-modules/blob/main/mmv1/api/resource/iam_policy.rb target=_blank rel=noopener>IAM policy YAML reference ↗</a></li></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/magic-modules/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Best practices</strong>
<label for=toc-control><img src=/magic-modules/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#forcenew>ForceNew</a><ul><li><a href=#mitigating-data-loss-risk-via-deletion_protection>Mitigating data loss risk via deletion_protection</a></li></ul></li><li><a href=#deletion-policy>Deletion policy</a></li><li><a href=#add-labels-and-annotations-support>Add labels and annotations support</a><ul><li><a href=#labels-support>Labels support</a></li><li><a href=#annotations-support>Annotations support</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=best-practices>Best practices
<a class=anchor href=#best-practices>#</a></h1><p>The following is a list of best practices that contributions are expected to follow in order to ensure a consistent UX for the Terraform provider for Google Cloud internally and also compared to other Terraform providers.</p><h2 id=forcenew>ForceNew
<a class=anchor href=#forcenew>#</a></h2><p><a href=https://developer.hashicorp.com/terraform/intro#how-does-terraform-work><code>ForceNew</code></a> in a Terraform resource schema attribute that indicates that a field is immutable – that is, that a change to the field requires the resource to be destroyed and recreated.</p><p>This is necessary and required for cases where a field can&rsquo;t be updated in-place, so that <a href=https://developer.hashicorp.com/terraform/intro#how-does-terraform-work>Terraform&rsquo;s core workflow</a> of aligning real infrastructure with configuration can be achieved. If a field or resource can never be updated in-place and is not marked with <code>ForceNew</code>, that is considered a bug in the provider.</p><p>Some fields or resources may be possible to update in place, but only under specific conditions. In these cases, you can treat the field as updatable - that is, do not mark it as ForceNew; instead, implement standard update functionality. Then, call <code>diff.ForceNew</code> inside a <a href=https://developer.hashicorp.com/terraform/plugin/sdkv2/resources/customizing-differences><code>CustomizeDiff</code></a> if the appropriate conditions to allow update in place are not met. Any <code>CustomizeDiff</code> function like this must be thoroughly unit tested. Making a field conditionally updatable like this is considered a good and useful enhancement in cases where recreation is costly and conditional updates do not introduce undue complexity.</p><p>In complex cases, it is better to mark the field <code>ForceNew</code> to ensure that users can apply their configurations successfully.</p><h3 id=mitigating-data-loss-risk-via-deletion_protection>Mitigating data loss risk via deletion_protection
<a class=anchor href=#mitigating-data-loss-risk-via-deletion_protection>#</a></h3><p>Some resources, such as databases, have a significant risk of unrecoverable data loss if the resource is accidentally deleted due to a change to a ForceNew field. For these resources, the best practice is to add a <code>deletion_protection</code> field that defaults to <code>true</code>, which prevents the resource from being deleted if enabled. Although it is a small breaking change, for users, the benefits of <code>deletion_protection</code> defaulting to <code>true</code> outweigh the cost.</p><p>APIs also sometimes add <code>deletion_protection</code> fields, which will generally default to <code>false</code> for backwards-compatibility reasons. Any <code>deletion_protection</code> API field added to an existing Terraform resource must match the API default initially. The default may be set to <code>true</code> in the next major release. For new Terraform resources, any <code>deletion_protection</code> field should default to <code>true</code> in Terraform regardless of the API default. When creating the corresponding Terraform field, the name
should match the API field name (i.e. it need not literally be named <code>deletion_protection</code> if the API uses something different) and should be the same field type (example: if the API field is an enum, so should the Terraform field).</p><p>A resource can have up to two <code>deletion_protection</code> fields (with different names): one that represents a field in the API, and one that is only in Terraform. This could happen because the API added its field after <code>deletion_protection</code> already existed in Terraform; it could also happen because a separate field was added in Terraform to make sure that <code>deletion_protection</code> is enabled by default. In either case, they should be reconciled into a single field (that defaults to enabled and whose name matches the API field) in the next major release.</p><p>Resources that do not have a significant risk of unrecoverable data loss or similar critical concern will not be given <code>deletion_protection</code> fields.</p><blockquote class="book-hint info"><strong>Note:</strong> The previous best practice was a field called <code>force_delete</code> that defaulted to <code>false</code>. This is still present on some resources for backwards-compatibility reasons, but <code>deletion_protection</code> is preferred going forward.</blockquote><h2 id=deletion-policy>Deletion policy
<a class=anchor href=#deletion-policy>#</a></h2><p>Some resources need to let users control the actions taken add deletion time. For these resources, the best practice is to add a <code>deletion_policy</code> enum field that defaults to an empty string and allows special values that control the deletion behavior.</p><p>One common example is <code>ABANDON</code>, which is useful if the resource is safe to delete from Terraform but could cause problems if deleted from the API - for example, <code>google_bigtable_gc_policy</code> deletion can fail in replicated instances. <code>ABANDON</code> indicates that attempts to delete the resource should remove it from state without actually deleting it.</p><p>See <a href=https://github.com/hashicorp/terraform-provider-google/pull/13107>magic-modules#13107</a> for an example of adding a <code>deletion_policy</code> field to an existing resource.</p><h2 id=add-labels-and-annotations-support>Add labels and annotations support
<a class=anchor href=#add-labels-and-annotations-support>#</a></h2><p>The new labels model and the new annotations model are introduced in <a href=https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/version_5_upgrade#provider>Terraform provider for Google Cloud 5.0.0</a>.</p><p>There are now three label-related fields with the new labels model:</p><ul><li>The <code>labels</code> field is now non-authoritative and only manages the label keys defined in your configuration for the resource.</li><li>The <code>terraform_labels</code> cannot be specified directly by the user. It merges the labels defined in the resource&rsquo;s configuration and the default labels configured in the provider block. If the same label key exists on both the resource level and provider level, the value on the resource will override the provider-level default.</li><li>The output-only <code>effective_labels</code> will list all the labels present on the resource in GCP, including the labels configured through Terraform, the system, and other clients.</li></ul><p>There are now two annotation-related fields with the new annotations model:</p><ul><li>The <code>annotations</code> field is now non-authoritative and only manages the annotation keys defined in your configuration for the resource.</li><li>The output-only <code>effective_annotations</code> will list all the annotations present on the resource in GCP, including the annotations configured through Terraform, the system, and other clients.</li></ul><p>This document describes how to add <code>labels</code> and <code>annotations</code> field to resources to support the new models.</p><h3 id=labels-support>Labels support
<a class=anchor href=#labels-support>#</a></h3><p>When adding a new <code>labels</code> field, please make the changes below to support the new labels model. Otherwise, it has to wait for the next major release to make the changes.</p><h4 id=mmv1-resources>MMv1 resources
<a class=anchor href=#mmv1-resources>#</a></h4><ol><li>Use the type <code>KeyValueLabels</code> for the standard resource <code>labels</code> field. The standard resource <code>labels</code> field could be the top level <code>labels</code> field or the nested <code>labels</code> field inside the top level <code>metadata</code> field. Don&rsquo;t add <code>default_from_api: true</code> to this field or don&rsquo;t use this type for other <code>labels</code> fields in the resource. <code>KeyValueLabels</code> will add all of changes required for the new model automatically.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- !<span style=color:#ae81ff>ruby/object:Api::Type::KeyValueLabels</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#39;labels&#39;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>description</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   The labels associated with this dataset. You can use these to
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   organize and group your datasets.</span>   
</span></span></code></pre></div><ol start=2><li>In the handwritten acceptance tests, add <code>labels</code> and <code>terraform_labels</code> to <code>ImportStateVerifyIgnore</code> if <code>labels</code> field is in the configuration.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>ImportStateVerifyIgnore</span>: []<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;labels&#34;</span>, <span style=color:#e6db74>&#34;terraform_labels&#34;</span>}, 
</span></span></code></pre></div><ol start=3><li>In the corresponding data source, after the resource read method, call the function <code>tpgresource.SetDataSourceLabels(d)</code> to make <code>labels</code> and <code>terraform_labels</code> have all of the labels on the resource.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>resourceArtifactRegistryRepositoryRead</span>(<span style=color:#a6e22e>d</span>, <span style=color:#a6e22e>meta</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tpgresource</span>.<span style=color:#a6e22e>SetDataSourceLabels</span>(<span style=color:#a6e22e>d</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=handwritten-resources>Handwritten resources
<a class=anchor href=#handwritten-resources>#</a></h4><ol><li>Add <code>tpgresource.SetLabelsDiff</code> to <code>CustomizeDiff</code> of the resource.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>CustomizeDiff</span>: <span style=color:#a6e22e>customdiff</span>.<span style=color:#a6e22e>All</span>(
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>tpgresource</span>.<span style=color:#a6e22e>SetLabelsDiff</span>,
</span></span><span style=display:flex><span>),
</span></span></code></pre></div><ol start=2><li>Add <code>labels</code> field and add more attributes (such as <code>ForceNew: true,</code>, <code>Set: schema.HashString,</code>) to this field if necessary.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#e6db74>&#34;labels&#34;</span>: {
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>Type</span>:     <span style=color:#a6e22e>schema</span>.<span style=color:#a6e22e>TypeMap</span>,
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>Optional</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>Elem</span>:     <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>schema</span>.<span style=color:#a6e22e>Schema</span>{<span style=color:#a6e22e>Type</span>: <span style=color:#a6e22e>schema</span>.<span style=color:#a6e22e>TypeString</span>},
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>Description</span>: <span style=color:#e6db74>`A set of key/value label pairs to assign to the project.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   **Note**: This field is non-authoritative, and will only manage the labels present in your configuration.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   Please refer to the field &#39;effective_labels&#39; for all of the labels present on the resource.`</span>,
</span></span><span style=display:flex><span>},
</span></span></code></pre></div><ol start=3><li>Add output only field <code>terraform_labels</code> and add more attributes (such as <code>Set: schema.HashString,</code>) to this field if necessary. Don&rsquo;t add <code>ForceNew:true,</code> to this field.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#e6db74>&#34;terraform_labels&#34;</span>: {
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>Type</span>:        <span style=color:#a6e22e>schema</span>.<span style=color:#a6e22e>TypeMap</span>,
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>Computed</span>:    <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>Description</span>: <span style=color:#e6db74>`The combination of labels configured directly on the resource and default labels configured on the provider.`</span>,
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>Elem</span>:        <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>schema</span>.<span style=color:#a6e22e>Schema</span>{<span style=color:#a6e22e>Type</span>: <span style=color:#a6e22e>schema</span>.<span style=color:#a6e22e>TypeString</span>},
</span></span><span style=display:flex><span>},
</span></span></code></pre></div><ol start=4><li>Add output only field <code>effective_labels</code> and add more attributes (such as <code>ForceNew: true,</code>, <code>Set: schema.HashString,</code>) to this field if necessary.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#e6db74>&#34;effective_labels&#34;</span>: {
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>Type</span>:        <span style=color:#a6e22e>schema</span>.<span style=color:#a6e22e>TypeMap</span>,
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>Computed</span>:    <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>Description</span>: <span style=color:#e6db74>`All of labels (key/value pairs) present on the resource in GCP, including the labels configured through Terraform, other clients and services.`</span>,
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>Elem</span>:        <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>schema</span>.<span style=color:#a6e22e>Schema</span>{<span style=color:#a6e22e>Type</span>: <span style=color:#a6e22e>schema</span>.<span style=color:#a6e22e>TypeString</span>},
</span></span><span style=display:flex><span>},
</span></span></code></pre></div><ol start=5><li>In the create method, use the value of <code>effective_labels</code> in API request.</li><li>In the update method, use the value of <code>effective_labels</code> in API request.</li><li>In the read mehtod, set <code>labels</code>, <code>terraform_labels</code> and <code>effective_labels</code> to state.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tpgresource</span>.<span style=color:#a6e22e>SetLabels</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>Labels</span>, <span style=color:#a6e22e>d</span>, <span style=color:#e6db74>&#34;labels&#34;</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;Error setting labels: %s&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tpgresource</span>.<span style=color:#a6e22e>SetLabels</span>(<span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>Labels</span>, <span style=color:#a6e22e>d</span>, <span style=color:#e6db74>&#34;terraform_labels&#34;</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;Error setting terraform_labels: %s&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;effective_labels&#34;</span>, <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>Labels</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;Error setting effective_labels: %s&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=8><li>In the handwritten acceptance tests, add <code>labels</code> and <code>terraform_labels</code> to <code>ImportStateVerifyIgnore</code>.</li><li>In the corresponding data source, after the resource read method, call the function <code>tpgresource.SetDataSourceLabels(d)</code> to make <code>labels</code> and <code>terraform_labels</code> have all of the labels on the resource.</li><li>Add the documentation for these label-related fields.</li></ol><h3 id=annotations-support>Annotations support
<a class=anchor href=#annotations-support>#</a></h3><p>When adding a new <code>annotations</code> field, please make the changes below below to support the new annotations model. Otherwise, it has to wait for the next major release to make the breaking changes.</p><h4 id=mmv1-resources-1>MMv1 resources
<a class=anchor href=#mmv1-resources-1>#</a></h4><ol><li>Use the type <code>KeyValueAnnotations</code> for the standard resource <code>annotations</code> field. The standard resource <code>annotations</code> field could be the top level <code>annotations</code> field or the nested <code>annotations</code> field inside the top level <code>metadata</code> field. Don&rsquo;t add <code>default_from_api: true</code> to this field or don&rsquo;t use this type for other <code>annotations</code> fields in the resource. <code>KeyValueAnnotations</code> will add all of changes required for the new model automatically.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- !<span style=color:#ae81ff>ruby/object:Api::Type::KeyValueAnnotations</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#39;annotations&#39;</span>
</span></span><span style=display:flex><span>   <span style=color:#f92672>description</span>: <span style=color:#e6db74>&#39;Client-specified annotations. This is distinct from labels.&#39;</span>
</span></span></code></pre></div><ol start=2><li>In the handwritten acceptance tests, add <code>annotations</code> to <code>ImportStateVerifyIgnore</code> if <code>annotations</code> field is in the configuration.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>ImportStateVerifyIgnore</span>: []<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;annotations&#34;</span>},
</span></span></code></pre></div><ol start=3><li>In the corresponding data source, after the resource read method, call the function <code>tpgresource.SetDataSourceAnnotations(d)</code> to make <code>annotations</code> have all of the annotations on the resource.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>resourceSecretManagerSecretRead</span>(<span style=color:#a6e22e>d</span>, <span style=color:#a6e22e>meta</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tpgresource</span>.<span style=color:#a6e22e>SetDataSourceLabels</span>(<span style=color:#a6e22e>d</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>tpgresource</span>.<span style=color:#a6e22e>SetDataSourceAnnotations</span>(<span style=color:#a6e22e>d</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=handwritten-resources-1>Handwritten resources
<a class=anchor href=#handwritten-resources-1>#</a></h4><ol><li>Add <code>tpgresource.SetAnnotationsDiff</code> to <code>CustomizeDiff</code> of the resource.</li><li>Add <code>annotations</code> field and add more attributes (such as <code>ForceNew: true,</code>, <code>Set: schema.HashString,</code>) to this field if necessary.</li><li>Add output only field <code>effective_annotations</code> and add more attributes (such as <code>ForceNew: true,</code>, <code>Set: schema.HashString,</code>) to this field if necessary.</li><li>In the create method, use the value of <code>effective_annotations</code> in API request.</li><li>In the update method, use the value of <code>effective_annotations</code> in API request.</li><li>In the read mehtod, set <code>annotations</code>, and <code>effective_annotations</code> to state.</li><li>In the handwritten acceptance tests, add <code>annotations</code> to <code>ImportStateVerifyIgnore</code>.</li><li>In the corresponding data source, after the resource read method, call the function <code>tpgresource.SetDataSourceAnnotations(d)</code> to make <code>annotations</code> have all of the labels on the resource.</li><li>Add the documentation for these annotation-related fields.</li></ol></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/GoogleCloudPlatform/magic-modules/commit/9f98cde4b2e5946ec446d572c08d0ea15dfb6a57 title='Last modified by Riley Karson | March 4, 2024' target=_blank rel=noopener><img src=/magic-modules/svg/calendar.svg class=book-icon alt=Calendar>
<span>March 4, 2024</span></a></div><div><a class="flex align-center" href="https://github.com/hashicorp/terraform-provider-google/issues/new?assignees=&labels=technical-debt,documentation&projects=&title=MM%20docsite%20issue%20in%20content/best-practices%2f_index.md&template=11_developer_productivity.md" target=_blank rel=noopener><img src=/magic-modules/report.svg class=book-icon alt=Edit>
<span>Report documentation issue</span></a></div><div><a class="flex align-center" href=https://github.com/GoogleCloudPlatform/magic-modules/edit/main/docs/content/best-practices/_index.md target=_blank rel=noopener><img src=/magic-modules/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#forcenew>ForceNew</a><ul><li><a href=#mitigating-data-loss-risk-via-deletion_protection>Mitigating data loss risk via deletion_protection</a></li></ul></li><li><a href=#deletion-policy>Deletion policy</a></li><li><a href=#add-labels-and-annotations-support>Add labels and annotations support</a><ul><li><a href=#labels-support>Labels support</a></li><li><a href=#annotations-support>Annotations support</a></li></ul></li></ul></nav></div></aside></main></body></html>